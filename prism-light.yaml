esphome:
  name: prism-light

esp8266:
  board: esp01_1m

# Enable logging
logger:
  baud_rate: 0

# Enable Home Assistant API
api:
  password: ""

ota:
  password: ""

wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password

  # Enable fallback hotspot (captive portal) in case wifi connection fails
  ap:
    ssid: "Prism-Light Fallback Hotspot"
    password: "lLTlK5z1u4Lo"

captive_portal:

uart:
   rx_pin: GPIO3
   tx_pin: GPIO1
   baud_rate: 9600

time:
  - platform: homeassistant
    id: esptime
tuya:
  time_id: esptime
  # on_datapoint_update:
  #   - sensor_datapoint: 24
  #     datapoint_type: any
  #     then:
  #       - lambda: |-
  #           return;

# power: 20
# brightness: 22
#   range: 10-1000
# color_temp: 23
#   range: 2700-6500
# color_mode: 21
# color: 24
# scene: 101
#   id: any byte
#   sp: speed, 0x64
#   mo: mode, 0x[fade,flash,music]
#   pt: pattern, 0x[solid,up,down,center,stripe,out,in,rot,spiral]
#   HSV: 0x0168, 0x03e8, (0x000a:0x03e8)
#   effect_bytes: {id}{sp}{mo}{pt}[colors:{hue}{sat}{vals}0000]
globals:
  - id: pattern
    type: std::string
    restore_value: no
    initial_value: ''

script:
  - id: set_pattern
    then:
      - lambda: |-
          ESP_LOGD("set_pattern","Attempting to write");
          tuya_tuya->set_string_datapoint_value(101, id(pattern));
          tuya_tuya->set_enum_datapoint_value(21,2);
  - id: stop_pattern
    then:
      - lambda: |-
          tuya_tuya->set_enum_datapoint_value(21,1);
# ESP_LOGD("set_pattern","Enter function, copying pattern data");
# const std::string cpattern = id(pattern);


light:
  - platform: tuya
    name: Prism
    id: prism
    icon: 'mdi:triangle-outline'
    switch_datapoint: 20
    dimmer_datapoint: 22
    hsv_datapoint: 24
    color_temperature_datapoint: 23
    color_temperature_max_value: 255
    min_value: 10
    max_value: 1000
    cold_white_color_temperature: 6500K
    warm_white_color_temperature: 2700K
    on_state:
      - if:
          condition:
            lambda: 'return id(prism).get_effect_name() == "None";'
          then:
            - script.execute: stop_pattern
    effects:
      - lambda:
          name: Hyperion
          update_interval: 1s
          lambda: |-
            id(pattern) = "10320003001c03e803e800000000012c03c003e80000000000c703e803e800000000";
            id(set_pattern).execute();
      - lambda:
          name: Hypnotize
          update_interval: 1s
          lambda: |-
            id(pattern) = "083c0001000003e803e800000000001e03e803e800000000003c03e803e800000000007803e803e80000000000b403e803e80000000000f003e803e800000000010e03e803e800000000012c03e803e800000000";
            id(set_pattern).execute();
      - lambda:
          name: Vortex
          update_interval: 1s
          lambda: |-
            id(pattern) = "09640008000003e803e800000000001e03e803e800000000003c03e803e800000000007803e803e80000000000b403e803e80000000000f003e803e800000000010e03e803e800000000012c03e803e800000000";
            id(set_pattern).execute();
      - lambda:
          name: Sunset
          update_interval: 1s
          lambda: |-
            id(pattern) = "0b280002000003e803e800000000000003e803e800000000001e03e803e800000000001e03e803e800000000003c03e803e800000000003c03e803e800000000";
            id(set_pattern).execute();
# tuya::Tuya tuyamcu;
# tuyamcu.set_string_datapoint_value(dp, pattern);
# ESP_LOGD("Button","Wrote!");
button:
  - platform: template
    name: Hypnotize
    on_press:
      - lambda: |-
          const std::string cpattern = "083c0001000003e803e800000000001e03e803e800000000003c03e803e800000000007803e803e80000000000b403e803e80000000000f003e803e800000000010e03e803e800000000012c03e803e800000000";
          tuya_tuya->set_string_datapoint_value(101, cpattern);
          tuya_tuya->set_enum_datapoint_value(21,2);